# 📝 试卷生成功能使用说明

## 功能概述

**试卷生成功能**允许用户从历史批改记录中自动提取相似题目，生成PDF格式的练习试卷，方便打印和练习。

---

## ✨ 功能特点

1. **智能提取题目** - 自动从历史记录中提取AI推荐的相似题目
2. **PDF格式输出** - 生成专业的PDF格式试卷，支持打印
3. **中文完美支持** - 使用中文字体，确保中文显示正确
4. **灵活数量选择** - 可选择5/10/15/20题，根据可用题目自动调整
5. **一键下载分享** - 生成后可直接下载或分享到其他应用

---

## 🎯 使用步骤

### 步骤1：进入功能
在应用首页，点击**"生成试卷"**卡片

### 步骤2：查看统计信息
系统会显示：
- 历史记录数量
- 可用题目数量
- 推荐生成数量

### 步骤3：选择题目数量
点击底部的数字按钮选择题目数量（5/10/15/20题）
- 灰色按钮表示题目不足，无法选择
- 蓝色按钮表示可以选择

### 步骤4：预览题目（可选）
点击**"预览题目"**按钮查看将要生成的题目列表

### 步骤5：生成试卷
点击**"生成PDF试卷"**按钮
- 系统会自动生成PDF文件
- 生成完成后会弹出分享对话框
- 可以保存到文件或分享给其他应用

---

## 📋 试卷格式说明

生成的PDF试卷包含以下内容：

### 试卷头部
```
练习试卷

生成时间：2024年12月XX日 XX:XX
姓名：__________  分数：__________
-----------------------------------
```

### 题目格式
```
1. [题型]
   题目内容...
   
   答：_________________________________

2. [题型]
   题目内容...
   
   答：_________________________________
   
...
```

### 试卷尾部
- 页码标注
- 简洁的分割线

---

## ⚠️ 注意事项

### 使用前提
1. **必须有历史批改记录** - 至少完成一次作业批改
2. **需要相似题目** - 历史记录中必须包含AI推荐的相似题目
3. **题目数量限制** - 如果可用题目不足，会使用所有可用题目

### 常见问题

#### Q1: 显示"题目数量不足"怎么办？
**A:** 需要先完成更多作业批改，系统会自动推荐相似题目。每次批改后，AI都会生成相关的练习题。

#### Q2: PDF中文显示乱码怎么办？
**A:** 后端已配置中文字体支持（宋体），如果仍有问题，请检查服务器是否安装了中文字体文件。

#### Q3: 下载的PDF在哪里？
**A:** 
- **iOS**: 保存在"文件"应用中
- **Android**: 保存在"下载"文件夹或文档目录
- 也可以通过分享功能直接发送到其他应用

#### Q4: 可以自定义试卷内容吗？
**A:** 当前版本自动从历史记录中提取题目。后续版本将支持手动选择题目。

#### Q5: 生成失败怎么办？
**A:** 请检查：
1. 网络连接是否正常
2. 后端服务是否运行
3. 是否有足够的历史记录和题目

---

## 🛠️ 技术说明（开发者）

### 后端实现

#### 1. 试卷生成服务
**文件**: `llmhomework_Backend/app/services/paper_generator.py`

**核心功能**:
- 从历史记录中提取相似题目
- 使用ReportLab生成PDF
- 支持中文字体（宋体/黑体）
- 自动处理多行文本和分页

**关键类**:
```python
class PaperGenerator:
    def extract_similar_questions_from_history(...)
    def generate_paper_pdf(...)
```

#### 2. API端点
**文件**: `llmhomework_Backend/app/api/paper_endpoints.py`

**API列表**:
- `POST /api/paper/generate` - 生成并下载PDF
- `POST /api/paper/preview` - 预览题目列表
- `GET /api/paper/statistics` - 获取统计信息
- `GET /api/paper/health` - 健康检查

#### 3. 中文字体配置
**字体路径** (按优先级):
1. Windows: `C:/Windows/Fonts/simsun.ttc`
2. Linux: `/usr/share/fonts/truetype/simsun.ttc`
3. 项目本地: `llmhomework_Backend/fonts/`

**字体注册**:
```python
from reportlab.pdfbase import pdfmetrics
from reportlab.pdfbase.ttfonts import TTFont

pdfmetrics.registerFont(TTFont('SimSun', 'simsun.ttc'))
```

### 前端实现

#### 1. 试卷服务
**文件**: `llmhomework_Frontend/app/services/paperService.ts`

**核心方法**:
- `getStatistics()` - 获取统计信息
- `previewPaper()` - 预览题目
- `generateAndDownloadPaper()` - 生成并下载PDF

#### 2. 生成试卷界面
**文件**: `llmhomework_Frontend/app/screens/GeneratePaperScreen.tsx`

**功能组件**:
- 统计信息卡片
- 题目数量选择器
- 预览题目列表
- 生成和下载按钮

#### 3. 文件下载实现
使用 `expo-file-system` 和 `expo-sharing`:
```typescript
import * as FileSystem from 'expo-file-system';
import * as Sharing from 'expo-sharing';

// 下载PDF
const response = await fetch(url, { method: 'POST', ... });
const blob = await response.blob();

// 保存到文件系统
await FileSystem.writeAsStringAsync(fileUri, base64Data, {
  encoding: FileSystem.EncodingType.Base64,
});

// 分享文件
await Sharing.shareAsync(fileUri, {
  mimeType: 'application/pdf',
});
```

---

## 📦 依赖安装

### 后端依赖
```bash
cd llmhomework_Backend
pip install reportlab
```

### 前端依赖
```bash
cd llmhomework_Frontend
npm install expo-file-system expo-sharing
```

### 中文字体安装（服务器端）

**Windows**: 系统自带宋体

**Linux (Ubuntu/Debian)**:
```bash
sudo apt-get install fonts-wqy-zenhei
# 或者
sudo apt-get install ttf-mscorefonts-installer
```

**手动安装字体**:
1. 下载`simsun.ttc`字体文件
2. 放置到以下目录之一：
   - `/usr/share/fonts/truetype/`
   - `llmhomework_Backend/fonts/`
3. 更新字体缓存（Linux）:
   ```bash
   sudo fc-cache -fv
   ```

---

## 🚀 部署检查清单

### 后端部署
- [x] 安装ReportLab: `pip install reportlab`
- [x] 注册API蓝图到Flask应用
- [ ] 安装中文字体文件
- [ ] 测试PDF生成功能
- [ ] 配置文件上传目录权限

### 前端部署
- [x] 安装文件系统依赖
- [x] 注册新屏幕到导航器
- [x] 首页添加入口按钮
- [ ] 测试文件下载和分享
- [ ] 配置文件存储权限（iOS/Android）

### 测试清单
- [ ] 后端健康检查: `GET /api/paper/health`
- [ ] 统计信息获取: `GET /api/paper/statistics`
- [ ] 题目预览: `POST /api/paper/preview`
- [ ] PDF生成和下载: `POST /api/paper/generate`
- [ ] 前端界面显示正常
- [ ] 文件下载成功
- [ ] PDF中文显示正确

---

## 📝 更新日志

### v1.0.0 (2024-12-XX)
- ✨ 新增试卷生成功能
- ✨ 支持PDF格式输出
- ✨ 完美支持中文显示
- ✨ 支持5/10/15/20题灵活选择
- ✨ 一键下载和分享功能

---

## 💡 后续优化计划

### 短期优化（1-2周）
1. **手动选择题目** - 允许用户勾选想要的题目
2. **试卷样式** - 提供多种试卷模板选择
3. **答案附件** - 可选生成附带答案的试卷

### 中期优化（1-2月）
1. **知识点筛选** - 按知识点筛选题目
2. **难度分级** - 按难度自动排序题目
3. **自定义标题** - 支持自定义试卷标题和信息
4. **批量生成** - 一次生成多份不同的试卷

### 长期规划（3-6月）
1. **智能组卷** - AI根据学生薄弱点智能组卷
2. **历史试卷管理** - 保存和管理生成的试卷
3. **打印优化** - 优化打印效果，支持双面打印
4. **Word格式支持** - 支持导出为Word文档

---

## 📞 技术支持

遇到问题？请联系开发团队：
- 📧 邮箱: support@example.com
- 📱 电话: xxx-xxxx-xxxx
- 💬 问题反馈: [GitHub Issues]

---

**祝您使用愉快！🎉**

