# å‰ç«¯ AbortSignal.timeout å…¼å®¹æ€§ä¿®å¤æŒ‡å—

## ğŸ› é—®é¢˜æè¿°

**é”™è¯¯ä¿¡æ¯**:
```
TypeError: AbortSignal.timeout is not a function (it is undefined)
```

**é”™è¯¯ä½ç½®**: ChatService åˆ›å»ºå¯¹è¯æ—¶

**åŸå› **: `AbortSignal.timeout()` æ˜¯è¾ƒæ–°çš„ Web APIï¼ˆChrome 103+ï¼‰ï¼Œåœ¨ä»¥ä¸‹ç¯å¢ƒä¸­ä¸æ”¯æŒï¼š
- React Native (æ‰€æœ‰ç‰ˆæœ¬)
- Node.js < 18
- æ—§ç‰ˆæµè§ˆå™¨
- Safari < 15.4

---

## âœ… è§£å†³æ–¹æ¡ˆ

### æ–¹æ¡ˆ 1: ä½¿ç”¨å…¼å®¹çš„ AbortControllerï¼ˆæ¨èï¼‰

åœ¨ä½ çš„ **ChatService** æ–‡ä»¶ä¸­ï¼Œæ‰¾åˆ°ä½¿ç”¨ `AbortSignal.timeout()` çš„åœ°æ–¹ï¼Œæ›¿æ¢ä¸ºä»¥ä¸‹å…¼å®¹ä»£ç ï¼š

#### ä¿®æ”¹å‰ï¼ˆä¸å…¼å®¹ï¼‰:
```typescript
// âŒ è¿™ç§å†™æ³•åœ¨ React Native ä¸­ä¸å·¥ä½œ
const response = await fetch(url, {
  method: 'POST',
  headers: headers,
  body: JSON.stringify(payload),
  signal: AbortSignal.timeout(60000)  // âŒ ä¸å…¼å®¹
});
```

#### ä¿®æ”¹åï¼ˆå…¼å®¹ï¼‰:
```typescript
// âœ… å…¼å®¹æ‰€æœ‰ç¯å¢ƒçš„å†™æ³•
const controller = new AbortController();
const timeoutId = setTimeout(() => {
  controller.abort();
}, 60000); // 60ç§’è¶…æ—¶

try {
  const response = await fetch(url, {
    method: 'POST',
    headers: headers,
    body: JSON.stringify(payload),
    signal: controller.signal  // âœ… å…¼å®¹
  });
  
  clearTimeout(timeoutId); // æ¸…é™¤è¶…æ—¶
  
  // ... å¤„ç†å“åº”
  
} catch (error) {
  clearTimeout(timeoutId); // æ¸…é™¤è¶…æ—¶
  
  if (error.name === 'AbortError') {
    throw new Error('è¯·æ±‚è¶…æ—¶ï¼Œè¯·ç¨åé‡è¯•');
  }
  throw error;
}
```

---

### æ–¹æ¡ˆ 2: åˆ›å»ºå…¼å®¹æ€§å·¥å…·å‡½æ•°

åœ¨é¡¹ç›®ä¸­åˆ›å»ºä¸€ä¸ª `utils/abortSignal.ts` æ–‡ä»¶ï¼š

```typescript
/**
 * åˆ›å»ºå¸¦è¶…æ—¶çš„ AbortSignalï¼ˆå…¼å®¹æ‰€æœ‰ç¯å¢ƒï¼‰
 * @param timeoutMs è¶…æ—¶æ—¶é—´ï¼ˆæ¯«ç§’ï¼‰
 * @returns { signal, cleanup }
 */
export function createTimeoutSignal(timeoutMs: number): {
  signal: AbortSignal;
  cleanup: () => void;
} {
  const controller = new AbortController();
  const timeoutId = setTimeout(() => {
    controller.abort();
  }, timeoutMs);

  return {
    signal: controller.signal,
    cleanup: () => clearTimeout(timeoutId)
  };
}
```

#### ä½¿ç”¨ç¤ºä¾‹:

```typescript
import { createTimeoutSignal } from '@/utils/abortSignal';

async function createConversation(taskId: string) {
  const { signal, cleanup } = createTimeoutSignal(60000);
  
  try {
    const response = await fetch(url, {
      method: 'POST',
      headers: headers,
      body: JSON.stringify(payload),
      signal: signal
    });
    
    cleanup(); // è¯·æ±‚æˆåŠŸï¼Œæ¸…é™¤è¶…æ—¶
    return await response.json();
    
  } catch (error) {
    cleanup(); // è¯·æ±‚å¤±è´¥ï¼Œæ¸…é™¤è¶…æ—¶
    throw error;
  }
}
```

---

## ğŸ” å®šä½éœ€è¦ä¿®æ”¹çš„æ–‡ä»¶

æ ¹æ®é”™è¯¯å †æ ˆï¼Œä½ éœ€è¦ä¿®æ”¹ä»¥ä¸‹æ–‡ä»¶ï¼š

1. **ChatService.js/ts** - å¯¹è¯æœåŠ¡æ–‡ä»¶
   - æŸ¥æ‰¾ `AbortSignal.timeout` çš„ä½¿ç”¨
   - æŸ¥æ‰¾ `fetch()` è°ƒç”¨
   - æŸ¥æ‰¾ `createConversation` å‡½æ•°

2. **ChatScreen.tsx** - èŠå¤©ç•Œé¢
   - æŸ¥æ‰¾ `initConversation` å‡½æ•°

### æŸ¥æ‰¾å‘½ä»¤

åœ¨é¡¹ç›®æ ¹ç›®å½•æ‰§è¡Œï¼š

```bash
# æŸ¥æ‰¾ä½¿ç”¨ AbortSignal.timeout çš„æ–‡ä»¶
grep -r "AbortSignal.timeout" ./src

# æŸ¥æ‰¾ createConversation å‡½æ•°
grep -r "createConversation" ./src

# æŸ¥æ‰¾æ‰€æœ‰çš„ fetch è°ƒç”¨
grep -r "fetch(" ./src
```

---

## ğŸ“ å®Œæ•´ç¤ºä¾‹ï¼šä¿®å¤ ChatService

### ä¿®æ”¹å‰:

```typescript
// ChatService.ts
export class ChatService {
  async createConversation(taskId: string) {
    try {
      const response = await fetch(API_URL, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({ task_id: taskId }),
        signal: AbortSignal.timeout(60000)  // âŒ é—®é¢˜ä»£ç 
      });
      
      return await response.json();
    } catch (error) {
      console.error('åˆ›å»ºå¯¹è¯å¤±è´¥:', error);
      throw error;
    }
  }
  
  async sendMessage(message: string) {
    try {
      const response = await fetch(API_URL, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({ message }),
        signal: AbortSignal.timeout(60000)  // âŒ é—®é¢˜ä»£ç 
      });
      
      return await response.json();
    } catch (error) {
      console.error('å‘é€æ¶ˆæ¯å¤±è´¥:', error);
      throw error;
    }
  }
}
```

### ä¿®æ”¹å:

```typescript
// ChatService.ts
export class ChatService {
  /**
   * åˆ›å»ºå¸¦è¶…æ—¶çš„è¯·æ±‚
   */
  private async fetchWithTimeout(
    url: string,
    options: RequestInit,
    timeoutMs: number = 60000
  ): Promise<Response> {
    const controller = new AbortController();
    const timeoutId = setTimeout(() => controller.abort(), timeoutMs);
    
    try {
      const response = await fetch(url, {
        ...options,
        signal: controller.signal
      });
      clearTimeout(timeoutId);
      return response;
    } catch (error) {
      clearTimeout(timeoutId);
      if (error.name === 'AbortError') {
        throw new Error('è¯·æ±‚è¶…æ—¶ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥');
      }
      throw error;
    }
  }
  
  async createConversation(taskId: string) {
    try {
      console.log('ğŸš€ [ChatService] å¼€å§‹åˆ›å»ºå¯¹è¯:', new Date().toISOString());
      
      const response = await this.fetchWithTimeout(
        API_URL,
        {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({ task_id: taskId })
        },
        60000  // 60ç§’è¶…æ—¶
      );
      
      if (!response.ok) {
        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
      }
      
      const data = await response.json();
      console.log('âœ… [ChatService] å¯¹è¯åˆ›å»ºæˆåŠŸ');
      return data;
      
    } catch (error) {
      console.error('âŒ [ChatService] åˆ›å»ºå¯¹è¯å¤±è´¥:', error);
      throw error;
    }
  }
  
  async sendMessage(message: string) {
    try {
      console.log('ğŸ“¤ [ChatService] å‘é€æ¶ˆæ¯:', message.substring(0, 50));
      
      const response = await this.fetchWithTimeout(
        API_URL,
        {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({ message })
        },
        60000  // 60ç§’è¶…æ—¶
      );
      
      if (!response.ok) {
        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
      }
      
      const data = await response.json();
      console.log('âœ… [ChatService] æ¶ˆæ¯å‘é€æˆåŠŸ');
      return data;
      
    } catch (error) {
      console.error('âŒ [ChatService] å‘é€æ¶ˆæ¯å¤±è´¥:', error);
      throw error;
    }
  }
}
```

---

## ğŸ”§ ä¿®æ”¹ ChatScreen.tsx

### ä¿®æ”¹å‰:

```typescript
const initConversation = async () => {
  try {
    console.log('ğŸš€ åˆå§‹åŒ–å¯¹è¯:', new Date().toISOString());
    await chatService.createConversation(taskId);
  } catch (error) {
    console.error('âŒ åˆå§‹åŒ–å¯¹è¯å¤±è´¥:', error);
  }
};
```

### ä¿®æ”¹å:

```typescript
const initConversation = async () => {
  try {
    console.log('ğŸš€ åˆå§‹åŒ–å¯¹è¯:', new Date().toISOString());
    await chatService.createConversation(taskId);
    console.log('âœ… å¯¹è¯åˆå§‹åŒ–æˆåŠŸ');
  } catch (error) {
    console.error('âŒ åˆå§‹åŒ–å¯¹è¯å¤±è´¥:', error);
    
    // ç”¨æˆ·å‹å¥½çš„é”™è¯¯æç¤º
    if (error.message.includes('è¶…æ—¶')) {
      Alert.alert('æç¤º', 'æœåŠ¡å™¨å“åº”è¶…æ—¶ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥åé‡è¯•');
    } else if (error.message.includes('ç½‘ç»œ')) {
      Alert.alert('æç¤º', 'ç½‘ç»œè¿æ¥å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè®¾ç½®');
    } else {
      Alert.alert('æç¤º', 'å¯¹è¯åˆå§‹åŒ–å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•');
    }
  }
};
```

---

## ğŸ¯ React Native ä¸“ç”¨æ–¹æ¡ˆ

å¦‚æœä½ ä½¿ç”¨çš„æ˜¯ React Nativeï¼Œæ¨èä½¿ç”¨ `react-native-fetch-api` æˆ–è‡ªå®šä¹‰è¶…æ—¶å®ç°ï¼š

### å®‰è£…ä¾èµ–ï¼ˆå¯é€‰ï¼‰:

```bash
npm install react-native-fetch-api
# æˆ–
yarn add react-native-fetch-api
```

### ä½¿ç”¨ç¤ºä¾‹:

```typescript
import { fetch } from 'react-native-fetch-api';

// ç„¶åæ­£å¸¸ä½¿ç”¨ fetchï¼Œå®ƒä¼šè‡ªåŠ¨å¤„ç†å…¼å®¹æ€§
```

---

## âœ… éªŒè¯ä¿®å¤

ä¿®æ”¹å®Œæˆåï¼Œæµ‹è¯•ä»¥ä¸‹åœºæ™¯ï¼š

### 1. æ­£å¸¸å¯¹è¯æµ‹è¯•

```typescript
// æµ‹è¯•ä»£ç 
async function testChat() {
  try {
    const service = new ChatService();
    const result = await service.createConversation('test_task_001');
    console.log('âœ… æµ‹è¯•é€šè¿‡:', result);
  } catch (error) {
    console.error('âŒ æµ‹è¯•å¤±è´¥:', error);
  }
}
```

### 2. è¶…æ—¶æµ‹è¯•

```typescript
// æµ‹è¯•è¶…æ—¶æƒ…å†µï¼ˆå°†è¶…æ—¶è®¾ç½®ä¸ºå¾ˆçŸ­ï¼‰
private async fetchWithTimeout(
  url: string,
  options: RequestInit,
  timeoutMs: number = 100  // è®¾ç½®ä¸º100msæµ‹è¯•è¶…æ—¶
): Promise<Response> {
  // ... åŒä¸Š
}
```

### 3. ç½‘ç»œé”™è¯¯æµ‹è¯•

```typescript
// æµ‹è¯•é”™è¯¯çš„URL
const response = await this.fetchWithTimeout(
  'http://invalid-url-12345.com',
  { method: 'POST' }
);
```

---

## ğŸ“Š å…¼å®¹æ€§å¯¹æ¯”

| æ–¹æ¡ˆ | React Native | Chrome | Safari | Node.js | æ¨èåº¦ |
|------|--------------|--------|--------|---------|--------|
| `AbortSignal.timeout()` | âŒ | âœ… (103+) | âœ… (15.4+) | âœ… (18+) | â­ |
| `AbortController + setTimeout` | âœ… | âœ… | âœ… | âœ… | â­â­â­â­â­ |
| `react-native-fetch-api` | âœ… | âœ… | âœ… | âŒ | â­â­â­ |

**æ¨è**: ä½¿ç”¨ `AbortController + setTimeout` æ–¹æ¡ˆï¼ˆæ–¹æ¡ˆ1æˆ–æ–¹æ¡ˆ2ï¼‰

---

## ğŸ› å¸¸è§é”™è¯¯å¤„ç†

### é”™è¯¯ 1: AbortError

```typescript
catch (error) {
  if (error.name === 'AbortError') {
    console.log('è¯·æ±‚è¢«å–æ¶ˆï¼ˆè¶…æ—¶æˆ–ç”¨æˆ·å–æ¶ˆï¼‰');
    throw new Error('è¯·æ±‚è¶…æ—¶ï¼Œè¯·ç¨åé‡è¯•');
  }
}
```

### é”™è¯¯ 2: NetworkError

```typescript
catch (error) {
  if (error.message.includes('Network request failed')) {
    console.log('ç½‘ç»œè¯·æ±‚å¤±è´¥');
    throw new Error('ç½‘ç»œè¿æ¥å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè®¾ç½®');
  }
}
```

### é”™è¯¯ 3: TypeError

```typescript
catch (error) {
  if (error instanceof TypeError) {
    console.log('ç±»å‹é”™è¯¯ï¼Œå¯èƒ½æ˜¯APIæ ¼å¼é—®é¢˜');
    throw new Error('æ•°æ®æ ¼å¼é”™è¯¯ï¼Œè¯·è”ç³»æŠ€æœ¯æ”¯æŒ');
  }
}
```

---

## ğŸ“ å¿«é€Ÿä¿®å¤æ¸…å•

- [ ] æ‰¾åˆ°æ‰€æœ‰ä½¿ç”¨ `AbortSignal.timeout()` çš„åœ°æ–¹
- [ ] æ›¿æ¢ä¸º `AbortController + setTimeout` æ–¹æ¡ˆ
- [ ] æ·»åŠ  `cleanup()` æ¸…ç†è¶…æ—¶å®šæ—¶å™¨
- [ ] æ·»åŠ é”™è¯¯å¤„ç†ï¼ˆè¶…æ—¶ã€ç½‘ç»œã€ç±»å‹é”™è¯¯ï¼‰
- [ ] æ·»åŠ ç”¨æˆ·å‹å¥½çš„é”™è¯¯æç¤º
- [ ] æµ‹è¯•æ­£å¸¸æµç¨‹
- [ ] æµ‹è¯•è¶…æ—¶æƒ…å†µ
- [ ] æµ‹è¯•ç½‘ç»œé”™è¯¯
- [ ] éªŒè¯ React Native ç¯å¢ƒè¿è¡Œæ­£å¸¸

---

## ğŸ‰ é¢„æœŸç»“æœ

ä¿®å¤åï¼Œä½ åº”è¯¥çœ‹åˆ°ï¼š

```
âœ… æ­£å¸¸æƒ…å†µ:
ğŸš€ åˆå§‹åŒ–å¯¹è¯: 2025-09-30T12:32:00.155Z
ğŸš€ [ChatService] å¼€å§‹åˆ›å»ºå¯¹è¯: 2025-09-30T12:32:00.155Z
âœ… [ChatService] å¯¹è¯åˆ›å»ºæˆåŠŸ
âœ… å¯¹è¯åˆå§‹åŒ–æˆåŠŸ

âŒ è¶…æ—¶æƒ…å†µ:
ğŸš€ [ChatService] å¼€å§‹åˆ›å»ºå¯¹è¯
âŒ [ChatService] åˆ›å»ºå¯¹è¯å¤±è´¥: è¯·æ±‚è¶…æ—¶ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥
Alert: æœåŠ¡å™¨å“åº”è¶…æ—¶ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥åé‡è¯•
```

---

## ğŸ’¡ é¢å¤–å»ºè®®

### 1. é…ç½®åŒ–è¶…æ—¶æ—¶é—´

```typescript
// config.ts
export const API_CONFIG = {
  CHAT_TIMEOUT: 60000,      // å¯¹è¯è¶…æ—¶ 60ç§’
  GRADING_TIMEOUT: 120000,  // æ‰¹æ”¹è¶…æ—¶ 120ç§’
  UPLOAD_TIMEOUT: 180000,   // ä¸Šä¼ è¶…æ—¶ 180ç§’
};

// ChatService.ts
import { API_CONFIG } from './config';

const response = await this.fetchWithTimeout(
  url,
  options,
  API_CONFIG.CHAT_TIMEOUT
);
```

### 2. æ·»åŠ é‡è¯•æœºåˆ¶

```typescript
async fetchWithRetry(
  url: string,
  options: RequestInit,
  maxRetries: number = 3
): Promise<Response> {
  for (let i = 0; i < maxRetries; i++) {
    try {
      return await this.fetchWithTimeout(url, options);
    } catch (error) {
      if (i === maxRetries - 1) throw error;
      console.log(`é‡è¯• ${i + 1}/${maxRetries}`);
      await new Promise(resolve => setTimeout(resolve, 1000 * (i + 1)));
    }
  }
  throw new Error('è¾¾åˆ°æœ€å¤§é‡è¯•æ¬¡æ•°');
}
```

### 3. æ·»åŠ è¯·æ±‚æ—¥å¿—

```typescript
private async fetchWithTimeout(
  url: string,
  options: RequestInit,
  timeoutMs: number = 60000
): Promise<Response> {
  const startTime = Date.now();
  
  try {
    const response = await /* ... */;
    console.log(`âœ… è¯·æ±‚æˆåŠŸ [${Date.now() - startTime}ms]: ${url}`);
    return response;
  } catch (error) {
    console.log(`âŒ è¯·æ±‚å¤±è´¥ [${Date.now() - startTime}ms]: ${url}`, error);
    throw error;
  }
}
```

---

**ä¿®å¤éš¾åº¦**: â­â­â˜†â˜†â˜† (ç®€å•)  
**å½±å“èŒƒå›´**: å‰ç«¯ ChatService å’Œç›¸å…³è°ƒç”¨  
**é¢„è®¡æ—¶é—´**: 10-20åˆ†é’Ÿ

ç¥ä¿®å¤é¡ºåˆ©ï¼å¦‚æœ‰é—®é¢˜éšæ—¶è”ç³»ã€‚ğŸ‰
