# 前端 AbortSignal.timeout 兼容性修复指南

## 🐛 问题描述

**错误信息**:
```
TypeError: AbortSignal.timeout is not a function (it is undefined)
```

**错误位置**: ChatService 创建对话时

**原因**: `AbortSignal.timeout()` 是较新的 Web API（Chrome 103+），在以下环境中不支持：
- React Native (所有版本)
- Node.js < 18
- 旧版浏览器
- Safari < 15.4

---

## ✅ 解决方案

### 方案 1: 使用兼容的 AbortController（推荐）

在你的 **ChatService** 文件中，找到使用 `AbortSignal.timeout()` 的地方，替换为以下兼容代码：

#### 修改前（不兼容）:
```typescript
// ❌ 这种写法在 React Native 中不工作
const response = await fetch(url, {
  method: 'POST',
  headers: headers,
  body: JSON.stringify(payload),
  signal: AbortSignal.timeout(60000)  // ❌ 不兼容
});
```

#### 修改后（兼容）:
```typescript
// ✅ 兼容所有环境的写法
const controller = new AbortController();
const timeoutId = setTimeout(() => {
  controller.abort();
}, 60000); // 60秒超时

try {
  const response = await fetch(url, {
    method: 'POST',
    headers: headers,
    body: JSON.stringify(payload),
    signal: controller.signal  // ✅ 兼容
  });
  
  clearTimeout(timeoutId); // 清除超时
  
  // ... 处理响应
  
} catch (error) {
  clearTimeout(timeoutId); // 清除超时
  
  if (error.name === 'AbortError') {
    throw new Error('请求超时，请稍后重试');
  }
  throw error;
}
```

---

### 方案 2: 创建兼容性工具函数

在项目中创建一个 `utils/abortSignal.ts` 文件：

```typescript
/**
 * 创建带超时的 AbortSignal（兼容所有环境）
 * @param timeoutMs 超时时间（毫秒）
 * @returns { signal, cleanup }
 */
export function createTimeoutSignal(timeoutMs: number): {
  signal: AbortSignal;
  cleanup: () => void;
} {
  const controller = new AbortController();
  const timeoutId = setTimeout(() => {
    controller.abort();
  }, timeoutMs);

  return {
    signal: controller.signal,
    cleanup: () => clearTimeout(timeoutId)
  };
}
```

#### 使用示例:

```typescript
import { createTimeoutSignal } from '@/utils/abortSignal';

async function createConversation(taskId: string) {
  const { signal, cleanup } = createTimeoutSignal(60000);
  
  try {
    const response = await fetch(url, {
      method: 'POST',
      headers: headers,
      body: JSON.stringify(payload),
      signal: signal
    });
    
    cleanup(); // 请求成功，清除超时
    return await response.json();
    
  } catch (error) {
    cleanup(); // 请求失败，清除超时
    throw error;
  }
}
```

---

## 🔍 定位需要修改的文件

根据错误堆栈，你需要修改以下文件：

1. **ChatService.js/ts** - 对话服务文件
   - 查找 `AbortSignal.timeout` 的使用
   - 查找 `fetch()` 调用
   - 查找 `createConversation` 函数

2. **ChatScreen.tsx** - 聊天界面
   - 查找 `initConversation` 函数

### 查找命令

在项目根目录执行：

```bash
# 查找使用 AbortSignal.timeout 的文件
grep -r "AbortSignal.timeout" ./src

# 查找 createConversation 函数
grep -r "createConversation" ./src

# 查找所有的 fetch 调用
grep -r "fetch(" ./src
```

---

## 📝 完整示例：修复 ChatService

### 修改前:

```typescript
// ChatService.ts
export class ChatService {
  async createConversation(taskId: string) {
    try {
      const response = await fetch(API_URL, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({ task_id: taskId }),
        signal: AbortSignal.timeout(60000)  // ❌ 问题代码
      });
      
      return await response.json();
    } catch (error) {
      console.error('创建对话失败:', error);
      throw error;
    }
  }
  
  async sendMessage(message: string) {
    try {
      const response = await fetch(API_URL, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({ message }),
        signal: AbortSignal.timeout(60000)  // ❌ 问题代码
      });
      
      return await response.json();
    } catch (error) {
      console.error('发送消息失败:', error);
      throw error;
    }
  }
}
```

### 修改后:

```typescript
// ChatService.ts
export class ChatService {
  /**
   * 创建带超时的请求
   */
  private async fetchWithTimeout(
    url: string,
    options: RequestInit,
    timeoutMs: number = 60000
  ): Promise<Response> {
    const controller = new AbortController();
    const timeoutId = setTimeout(() => controller.abort(), timeoutMs);
    
    try {
      const response = await fetch(url, {
        ...options,
        signal: controller.signal
      });
      clearTimeout(timeoutId);
      return response;
    } catch (error) {
      clearTimeout(timeoutId);
      if (error.name === 'AbortError') {
        throw new Error('请求超时，请检查网络连接');
      }
      throw error;
    }
  }
  
  async createConversation(taskId: string) {
    try {
      console.log('🚀 [ChatService] 开始创建对话:', new Date().toISOString());
      
      const response = await this.fetchWithTimeout(
        API_URL,
        {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({ task_id: taskId })
        },
        60000  // 60秒超时
      );
      
      if (!response.ok) {
        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
      }
      
      const data = await response.json();
      console.log('✅ [ChatService] 对话创建成功');
      return data;
      
    } catch (error) {
      console.error('❌ [ChatService] 创建对话失败:', error);
      throw error;
    }
  }
  
  async sendMessage(message: string) {
    try {
      console.log('📤 [ChatService] 发送消息:', message.substring(0, 50));
      
      const response = await this.fetchWithTimeout(
        API_URL,
        {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({ message })
        },
        60000  // 60秒超时
      );
      
      if (!response.ok) {
        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
      }
      
      const data = await response.json();
      console.log('✅ [ChatService] 消息发送成功');
      return data;
      
    } catch (error) {
      console.error('❌ [ChatService] 发送消息失败:', error);
      throw error;
    }
  }
}
```

---

## 🔧 修改 ChatScreen.tsx

### 修改前:

```typescript
const initConversation = async () => {
  try {
    console.log('🚀 初始化对话:', new Date().toISOString());
    await chatService.createConversation(taskId);
  } catch (error) {
    console.error('❌ 初始化对话失败:', error);
  }
};
```

### 修改后:

```typescript
const initConversation = async () => {
  try {
    console.log('🚀 初始化对话:', new Date().toISOString());
    await chatService.createConversation(taskId);
    console.log('✅ 对话初始化成功');
  } catch (error) {
    console.error('❌ 初始化对话失败:', error);
    
    // 用户友好的错误提示
    if (error.message.includes('超时')) {
      Alert.alert('提示', '服务器响应超时，请检查网络连接后重试');
    } else if (error.message.includes('网络')) {
      Alert.alert('提示', '网络连接失败，请检查网络设置');
    } else {
      Alert.alert('提示', '对话初始化失败，请稍后重试');
    }
  }
};
```

---

## 🎯 React Native 专用方案

如果你使用的是 React Native，推荐使用 `react-native-fetch-api` 或自定义超时实现：

### 安装依赖（可选）:

```bash
npm install react-native-fetch-api
# 或
yarn add react-native-fetch-api
```

### 使用示例:

```typescript
import { fetch } from 'react-native-fetch-api';

// 然后正常使用 fetch，它会自动处理兼容性
```

---

## ✅ 验证修复

修改完成后，测试以下场景：

### 1. 正常对话测试

```typescript
// 测试代码
async function testChat() {
  try {
    const service = new ChatService();
    const result = await service.createConversation('test_task_001');
    console.log('✅ 测试通过:', result);
  } catch (error) {
    console.error('❌ 测试失败:', error);
  }
}
```

### 2. 超时测试

```typescript
// 测试超时情况（将超时设置为很短）
private async fetchWithTimeout(
  url: string,
  options: RequestInit,
  timeoutMs: number = 100  // 设置为100ms测试超时
): Promise<Response> {
  // ... 同上
}
```

### 3. 网络错误测试

```typescript
// 测试错误的URL
const response = await this.fetchWithTimeout(
  'http://invalid-url-12345.com',
  { method: 'POST' }
);
```

---

## 📊 兼容性对比

| 方案 | React Native | Chrome | Safari | Node.js | 推荐度 |
|------|--------------|--------|--------|---------|--------|
| `AbortSignal.timeout()` | ❌ | ✅ (103+) | ✅ (15.4+) | ✅ (18+) | ⭐ |
| `AbortController + setTimeout` | ✅ | ✅ | ✅ | ✅ | ⭐⭐⭐⭐⭐ |
| `react-native-fetch-api` | ✅ | ✅ | ✅ | ❌ | ⭐⭐⭐ |

**推荐**: 使用 `AbortController + setTimeout` 方案（方案1或方案2）

---

## 🐛 常见错误处理

### 错误 1: AbortError

```typescript
catch (error) {
  if (error.name === 'AbortError') {
    console.log('请求被取消（超时或用户取消）');
    throw new Error('请求超时，请稍后重试');
  }
}
```

### 错误 2: NetworkError

```typescript
catch (error) {
  if (error.message.includes('Network request failed')) {
    console.log('网络请求失败');
    throw new Error('网络连接失败，请检查网络设置');
  }
}
```

### 错误 3: TypeError

```typescript
catch (error) {
  if (error instanceof TypeError) {
    console.log('类型错误，可能是API格式问题');
    throw new Error('数据格式错误，请联系技术支持');
  }
}
```

---

## 📝 快速修复清单

- [ ] 找到所有使用 `AbortSignal.timeout()` 的地方
- [ ] 替换为 `AbortController + setTimeout` 方案
- [ ] 添加 `cleanup()` 清理超时定时器
- [ ] 添加错误处理（超时、网络、类型错误）
- [ ] 添加用户友好的错误提示
- [ ] 测试正常流程
- [ ] 测试超时情况
- [ ] 测试网络错误
- [ ] 验证 React Native 环境运行正常

---

## 🎉 预期结果

修复后，你应该看到：

```
✅ 正常情况:
🚀 初始化对话: 2025-09-30T12:32:00.155Z
🚀 [ChatService] 开始创建对话: 2025-09-30T12:32:00.155Z
✅ [ChatService] 对话创建成功
✅ 对话初始化成功

❌ 超时情况:
🚀 [ChatService] 开始创建对话
❌ [ChatService] 创建对话失败: 请求超时，请检查网络连接
Alert: 服务器响应超时，请检查网络连接后重试
```

---

## 💡 额外建议

### 1. 配置化超时时间

```typescript
// config.ts
export const API_CONFIG = {
  CHAT_TIMEOUT: 60000,      // 对话超时 60秒
  GRADING_TIMEOUT: 120000,  // 批改超时 120秒
  UPLOAD_TIMEOUT: 180000,   // 上传超时 180秒
};

// ChatService.ts
import { API_CONFIG } from './config';

const response = await this.fetchWithTimeout(
  url,
  options,
  API_CONFIG.CHAT_TIMEOUT
);
```

### 2. 添加重试机制

```typescript
async fetchWithRetry(
  url: string,
  options: RequestInit,
  maxRetries: number = 3
): Promise<Response> {
  for (let i = 0; i < maxRetries; i++) {
    try {
      return await this.fetchWithTimeout(url, options);
    } catch (error) {
      if (i === maxRetries - 1) throw error;
      console.log(`重试 ${i + 1}/${maxRetries}`);
      await new Promise(resolve => setTimeout(resolve, 1000 * (i + 1)));
    }
  }
  throw new Error('达到最大重试次数');
}
```

### 3. 添加请求日志

```typescript
private async fetchWithTimeout(
  url: string,
  options: RequestInit,
  timeoutMs: number = 60000
): Promise<Response> {
  const startTime = Date.now();
  
  try {
    const response = await /* ... */;
    console.log(`✅ 请求成功 [${Date.now() - startTime}ms]: ${url}`);
    return response;
  } catch (error) {
    console.log(`❌ 请求失败 [${Date.now() - startTime}ms]: ${url}`, error);
    throw error;
  }
}
```

---

**修复难度**: ⭐⭐☆☆☆ (简单)  
**影响范围**: 前端 ChatService 和相关调用  
**预计时间**: 10-20分钟

祝修复顺利！如有问题随时联系。🎉
